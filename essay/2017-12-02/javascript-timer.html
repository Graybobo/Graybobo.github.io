<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1, minimum-scale=1, maximum-scale=1" />
        <meta name="x5-fullscreen" content="true" />
        <meta name="full-screen" content="yes" />
        <link rel="shortcut icon" href="/assets/images/favicon.ico" />
        <link rel="apple-itouch-icon" href="/assets/images/favicon.ico" />
        <link rel="stylesheet" href="/assets/styles/ux.css" />
        <script type="text/javascript">
        var timeSinceLang = {
            year: '年前',
            month: '个月前',
            day: '天前',
            hour: '小时前',
            minute: '分钟前',
            second: '秒前'
        };
        var root = '';
        </script>
        <meta name="keywords" content="JAVASCRIPT," />
        <meta name="description" content="setTimeout &amp; setInterval" />
        <meta name="author" content="{w:鵬}" />
        <title>setTimeout &amp; setInterval</title>
    </head>
    <body>
        <article class="container">

            <header class="header-wrap">
                <a class="index" href="/">
                    <img class="logo" src="/assets/images/avatar.png" />
                    KILLHAPPY.
                </a>
                <ul class="menu">
                    <li class="menu-item"><a href="/archive.html">ARCHIVE</a></li>
                    <li class="menu-item"><a href="/tag.html">TAG</a></li>
                </ul>
            </header>

            <article class="main article">
                <h1 class="title">setTimeout &amp; setInterval</h1>
                <section class="info">
                    
                    <a class="name" href="/me.html">{w:鵬}</a>
                    
                    <span class="date" data-time="1512145080"><span class="from"></span></span>
                    
                    <span class="tags"><a class="tag" href="/tag/JAVASCRIPT/index.html">JAVASCRIPT</a></span>
                </section>
                <article class="content">
                    <p>日前，团队小伙伴 D 同学做了 <code>Javascript 生命周期</code> 相关主题的分享。<br />
  分享会上，小伙伴们围绕 <code>setTimeout</code>、<code>Promise</code> 及 <code>process.nextTick</code> 等内容展开了激烈的讨论。</p>

<p>发现小伙伴们忽视了 <code>setTimeout</code> 及 <code>setInterval</code> 哪些隐秘的坑，于是凭借着数年前的记忆对 <code>setTimeout</code> 和 <code>setInterval</code> 做了一番阐述，由于对一些内容的印象模糊，总觉得解答的不尽人意，对不起观众。<br />
  于是，今天抽空又去啃了 MDN Web docs；翻了两本 Javascript 相关书籍。决定对 <code>setTimeout</code> 和 <code>setInterval</code> 那些被忽视的隐秘知识点做一个总结，同时加深一下印象。</p>

<h3>用途</h3>

<p><code>setTimeout</code> 是用来延迟执行一个任务，<code>setInterval</code> 是用来在一个时间间隔后重复的执行一个任务。</p>

<h3>最小时间间隔</h3>

<p><code>setTimeout</code> 与 <code>setInterval</code> 存在一个最小的时间间隔。</p>

<p>在 IE 老版本( IE8 以下 )中这个最小时间间隔大约为 15.6ms，后来优化精确到 10ms，IE10+ 为 4ms；<br />
  MDN Web docs 中提到，Firefox 中这个最小时间间隔为 10ms，Firefox 18+ 的测试时间约为 4ms；<br />
  Chrome、Opera、Safari 等测试数据显示这个最小时间间隔约为 4ms；<br />
  HTML5 新的标准规定 <code>setTimeout</code> 的最小时间间隔为 4ms，<code>setInterval</code> 的最小时间间隔为 10ms。</p>

<p>实际应用中：<br />
  ▪ 如果参数设定的时间间隔时间小于浏览器设定的默认最小时间间隔，那么浏览器会按照默认的最小时间间隔来处理；<br />
  ▪ 如果回调的执行时间大于间隔时间，那么回调会继续执行，导致真正的时间间隔比原来设定的会大一点。</p>

<h3>一些旧版本浏览器的优化方案</h3>

<p>对于一些老版本的浏览器 15ms+ 的最小时间间隔如果觉得间隔时间太大，那么我们可以考虑重写 <code>setTimeout</code> 等方法。<br />
  下面的例子利用 image 出现死链时立即触发执行 onerror 的机制重写了默认的 <code>setTimeout</code>:</p>

<pre><code>  var originalSetTimeOut = window.setTimeout;
  
  window.setTimeout = function( callback, time ) {
      if( time &lt; 15 ) {
          originalSetTimeOut( callback, time );
      }
      else {
          var IMG = new Image();

          IMG.onload = IMG.onerror = function() {
              callback();
          }

          IMG.src = &quot;data:,error&quot;;
      }
  };
</code></pre>

<h3>零秒延迟</h3>

<p>在某些情况下，我们希望被延迟的任务能够在较短的时间后被执行，我们会指定一个很小的间隔时间，甚至将时间设置为 <code>0</code> 值。<br />
  但是零秒延迟并不是真的会立即被执行，上面我们提到了浏览器会有一个最小的时间间隔设定。</p>

<p>那么零秒延迟到底有什么用呢？</p>

<p>我们知道，Javascript 在执行过程中会针对异步代码创建任务队列，<code>setTimeout(fn, 0)</code> 就是告诉浏览器“尽可能快”的去执行指定的回调任务，实现一个插队操作。</p>

<h3>省略时间参数的情况</h3>

<p>实际应用中，如果不指定第二个间隔时间参数，浏览器会自动分配一个间隔时间。</p>

<p>IE 和 Firefox 中，浏览器第一次可能会分配一个较大的间隔时间，约为 100ms，往后会减小到上面所说的最小时间间隔；<br />
  FireFox 中，<code>setInterval</code> 如果不指定第二个时间参数，会当作 <code>setTimeout</code> 处理，即只会执行一次。</p>

<p>Chrome、Opera、Safari 浏览器分配的间隔时间约为 10ms。</p>

<h3>额外的参数( 不止两个参数 )</h3>

<p>IE10+ 和标准浏览器，除支持 <code>callback</code> 和 <code>time</code> 两个参数外，还支持额外的参数，作为回调函数的参数( 即第一个参数 callback 的参数 )。</p>

<pre><code>  setTimeout(function() {
      console.log( [].slice.call( arguments ) );
  }, 100, &quot;A&quot;, &quot;B&quot;, &quot;C&quot;);
</code></pre>

<h3>时间参数极端值的情况</h3>

<p>如果时间参数为负数、极小极小的负数或极大的正数，各种浏览器的处理会出现比较大的出入，会出现立即执行或“不执行”( 是否真的不执行有待深究 )的情况。</p>

<p>感兴趣的话可以自己做些测试。</p>

<h3>其他的一些影响因素</h3>

<p>▪ 此外，浏览器的后台模式运行，页面窗口非活动状态( 页面不处于当前浏览窗口 ) 时，浏览器会对间隔时间做一些优化调整( 间隔时间会被调整到 1000ms )；<br />
  ▪ 同时，对于一些移动设备操作系统为了体验优化或节能状态下时，这个间隔时间也会受到影响；<br />
  ▪ 笔记本电脑，在没有外部电流供电仅靠电池供电状态下，浏览器也会对间隔时间做一些调整。</p>

<h3>参考资料</h3>

<p>▪ <a href="https://testdrive-archive.azurewebsites.net/Performance/setImmediateSorting/Default.html">https://testdrive-archive.azurewebsites.net/Performance/setImmediateSorting/Default.html</a><br />
  ▪ <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout">https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout</a><br />
  ▪ <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval">https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval</a></p>

                    
                    <p class="addr-link">
                        <b>本文地址: </b>
                        <script type="text/javascript">document.write(window.location.href);</script>
                        ( 转载请注明出处，谢谢！ )
                    </p>
                    
                </article>
                <section class="recommend">
                    
                    <section class="nav prev more">
                        <div class="head">上篇文章</div>
                        <a class="link" href="/essay/2018-03-12/nginx-map-multi-domain-proxy.html">Nginx map 实现多域名反代到同一后端服务的不同 Namespace</a>
                    </section>
                    
                    
                    <section class="nav next more">
                        <div class="head">下篇文章</div>
                        <a class="link" href="/essay/2017-12-01/go-package.html">Golang - Package</a>
                    </section>
                    
                </section>
            </article>
        </article>

        <section class="elegant">
            { <a href="/me.html">ABOUT ME</a> | <a href="/clip.html">CLIP</a> }
        </section>
        <footer class="footer">
            <span class="copyright">&copy;&nbsp;KILLHAPPY.</span>
        </footer>

        <script src="/assets/scripts/ux.js"></script>

    </body>
</html>
