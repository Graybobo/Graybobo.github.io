<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1, minimum-scale=1, maximum-scale=1" />
        <meta name="x5-fullscreen" content="true" />
        <meta name="full-screen" content="yes" />
        <link rel="shortcut icon" href="/assets/images/favicon.ico" />
        <link rel="apple-itouch-icon" href="/assets/images/favicon.ico" />
        <script type="text/javascript" src="/assets/scripts/ua.js"></script>
        <link rel="stylesheet" href="/assets/styles/ux.css" />
        <script type="text/javascript">
        var timeSinceLang = {
            year: '年前',
            month: '个月前',
            day: '天前',
            hour: '小时前',
            minute: '分钟前',
            second: '秒前'
        };
        var root = '';
        </script>
        <meta name="keywords" content="NGINX,运维," />
        <meta name="description" content="Nginx map 实现多域名反代到同一后端服务的不同 Namespace" />
        <meta name="author" content="{w:鵬}" />
        <title>Nginx map 实现多域名反代到同一后端服务的不同 Namespace</title>
    </head>
    <body>
        <article class="container">

            <header class="header-wrap">
                <a class="index" href="/">
                    <img class="logo" src="/assets/images/avatar.png" />
                    KILLHAPPY.
                </a>
                <ul class="menu">
                    <li class="menu-item"><a href="/archive.html">ARCHIVE</a></li>
                    <li class="menu-item"><a href="/tag.html">TAG</a></li>
                </ul>
            </header>

            <article class="main article">
                <h1 class="title">Nginx map 实现多域名反代到同一后端服务的不同 Namespace</h1>
                <section class="info">
                    
                    <a class="name" href="/me.html">{w:鵬}</a>
                    
                    <span class="date" data-time="1520860320"><span class="from"></span></span>
                    
                    <span class="tags"><a class="tag" href="/tag/NGINX/index.html">NGINX</a><a class="tag" href="/tag/%e8%bf%90%e7%bb%b4/index.html">运维</a></span>
                </section>
                <article class="content">
                    <p>最近，在部署新平台项目的 NODEJS 应用层服务，由于 NODEJS 应用层是一个多端( 移动端、PC 端等 )多业务模块( 多个域名 )混合应用服务。不同的业务模块使用了相对独立的域名，业务层面通过 Namespace 来做了服务隔离。</p>

<p>在做 Nginx 反代配置时，一时之间懵逼了，发现有近 10 多个域名( 不同的业务模块 )要处理，如果一个一个来，得配置 N 多个 <code>server</code> 实例，而且还要同时支持 http 和 https ，并将 http 自动转为 https 。第一时间想到了正则匹配及判断处理，写的时候觉得不够优雅，而且担心效率问题。</p>

<p>纠结一番后，决定将域名和 Namespace 放配置做一个映射，来简化处理逻辑，于是通过 OR 用 lua 脚本来做了处理。</p>

<p>折腾完后，在与 W 同学交流中，知道了 Nginx 本身是支持 map 的，没必要使用 lua 脚本来处理这么麻烦。于是，翻了翻 Nginx map 的相关文档，重新优化了配置，干掉了 lua 脚本。</p>

<p>废话结束，上配置示例：</p>

<pre><code>  ......

  map $host $namespace {
      a.xxx.com        namespace_a;
      b.xxx.com        namespace_b;
      c.xxx.com        namespace_c;
      d.xxx.com        namespace_d;
      e.xxx.com        namespace_e;
  }

  upstream node_application {  
      server     1.1.1.1;  
      keepalive  16;
  }

  server {

      listen               443 ssl;

      server_name          a.xxx.com;
      server_name          b.xxx.com;
      server_name          c.xxx.com;
      server_name          d.xxx.com;
      server_name          e.xxx.com;

      ssl_certificate      xxx.crt;
      ssl_certificate_key  xxx.key;

      location / {

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_pass http://node_application/$namespace$uri;
          proxy_http_version 1.1;
          proxy_set_header Connection &quot;&quot;;

      }

  }

  server {

      listen               80;

      server_name          a.xxx.com;
      server_name          b.xxx.com;
      server_name          c.xxx.com;
      server_name          d.xxx.com;
      server_name          e.xxx.com;

      rewrite ^(.*)$  https://$host$1  permanent;

  }

  ......
</code></pre>

<h3>参考资料</h3>

<p><a href="http://nginx.org/en/docs/http/ngx_http_map_module.html">http://nginx.org/en/docs/http/ngx_http_map_module.html</a></p>

                    
                    <p class="addr-link">
                        <b>本文地址: </b>
                        <script type="text/javascript">document.write(window.location.href);</script>
                        ( 转载请注明出处，谢谢！ )
                    </p>
                    
                </article>
                <section class="recommend">
                    
                    <section class="nav prev more">
                        <div class="head">上篇文章</div>
                        <a class="link" href="/essay/2018-04-01/devout-blessing.html">否极泰来</a>
                    </section>
                    
                    
                    <section class="nav next more">
                        <div class="head">下篇文章</div>
                        <a class="link" href="/essay/2017-12-02/javascript-timer.html">setTimeout &amp; setInterval</a>
                    </section>
                    
                </section>
            </article>
        </article>

        <section class="about-me">
            { <a href="/me.html">ABOUT ME</a> | <a href="/clip.html">CLIP</a> }
        </section>
        <footer class="footer">
            <span class="copyright">&copy;&nbsp;2017&nbsp;-&nbsp;<script type="text/javascript">document.write(new Date().getFullYear());</script>&nbsp;KILLHAPPY.</span>
        </footer>

        <script src="/assets/scripts/ux.js"></script>

    </body>
</html>
